<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperOS 動態版本檢視</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Microsoft JhengHei"', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 載入動畫 */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen pb-10">

    <!-- 頂部導覽列 -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">HyperOS TW Tracker</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="loadingStatus" class="flex items-center gap-2 text-xs text-blue-600 font-medium">
                            <div class="loader"></div> 正在讀取資料...
                        </span>
                        <span id="deviceCount" class="text-xs text-gray-500 hidden"></span>
                    </div>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                    <div class="relative group">
                        <select id="brandFilter" class="appearance-none bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 pl-4 pr-8 rounded-full text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors cursor-pointer border border-transparent">
                            <option value="all">所有品牌</option>
                            <!-- 品牌將由 JS 動態生成 -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <div class="relative flex-grow md:flex-grow-0 md:w-64">
                        <input type="text" id="searchInput" 
                            class="w-full bg-gray-100 hover:bg-gray-200 focus:bg-white text-gray-700 py-2.5 pl-10 pr-4 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all border border-transparent placeholder-gray-400" 
                            placeholder="搜尋機型名稱或代號...">
                        <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區 -->
    <div class="max-w-4xl mx-auto px-4 mt-6" id="content">
        <!-- 卡片將由 JS 動態生成 -->
    </div>
    
    <div class="max-w-4xl mx-auto px-4 py-8 text-center">
        <p class="text-xs text-gray-400">Powered by Dynamic Fetch • <a href="#" class="hover:underline">Top</a></p>
    </div>

    <script>
        // 設定常數
        const TARGET_TW = "小米澎湃 OS 中国台湾省正式版";
        const TARGET_GLOBAL = "小米澎湃 OS 国际正式版";
        
        // 全域資料儲存
        const allDevices = [];
        const foundBrands = new Set();
        let loadedCount = 0;
        let totalToLoad = 0;

        // 初始化
        async function init() {
            try {
                // 1. 讀取 devices.json 取得清單
                const response = await fetch('devices.json');
                if (!response.ok) throw new Error('無法讀取 devices.json');
                const indexData = await response.json();
                
                // 2. 解析出所有機型代號
                let deviceCodes = [];
                // 遍歷主要分類 (mi, redmi, etc.)
                for (const key in indexData) {
                    if (indexData[key].devices) {
                        indexData[key].devices.forEach(d => {
                            if (d.code) deviceCodes.push(d.code);
                        });
                    }
                }
                
                // 移除重複
                deviceCodes = [...new Set(deviceCodes)];
                totalToLoad = deviceCodes.length;
                
                console.log(`Found ${totalToLoad} devices to check.`);
                
                // 3. 開始平行讀取每個機型的詳細 JSON
                // 為了避免一次發出數百個請求卡死瀏覽器，我們分批次讀取
                const batchSize = 10;
                for (let i = 0; i < deviceCodes.length; i += batchSize) {
                    const batch = deviceCodes.slice(i, i + batchSize);
                    await Promise.all(batch.map(code => fetchDeviceData(code)));
                }

                // 4. 全部讀取完畢後的處理
                document.getElementById('loadingStatus').innerHTML = '<span class="text-green-600">✓ 資料更新完畢</span>';
                document.getElementById('deviceCount').textContent = `共 ${allDevices.length} 款機型`;
                document.getElementById('deviceCount').classList.remove('hidden');
                
                // 排序：依台灣版日期新到舊
                sortAndRender();
                updateBrandFilter();

            } catch (error) {
                console.error(error);
                document.getElementById('loadingStatus').innerHTML = `<span class="text-red-500">⚠ 讀取失敗: ${error.message} (請確保使用 Web Server 開啟)</span>`;
            }
        }

        async function fetchDeviceData(code) {
            try {
                const res = await fetch(`devices/${code}.json`);
                if (!res.ok) return;
                const data = await res.json();
                
                const processed = processDeviceData(data);
                if (processed) {
                    allDevices.push(processed);
                    foundBrands.add(processed.brand);
                    // 每讀取到一個有效的，就先更新畫面 (可選，這裡為了效能先不即時渲染，改為批次後統一渲染)
                }
            } catch (e) {
                // 某些機型可能沒有檔案，忽略錯誤
                // console.warn(`Skipped ${code}: ${e.message}`);
            } finally {
                loadedCount++;
            }
        }

        function processDeviceData(data) {
            const code = data.device || '';
            const name = data.name?.zh || 'Unknown';
            let brand = 'Other';
            
            let twData = null;
            let globalData = null;

            const branches = data.branches || [];
            
            branches.forEach(branch => {
                const bName = branch.name?.zh || '';
                
                if (bName === TARGET_TW) {
                    // 台灣版
                    const roms = branch.roms || {};
                    const list = getSortedRoms(roms);
                    if (list.length > 0) {
                        twData = list[0];
                        if (branch.brand) brand = branch.brand;
                    }
                } else if (bName === TARGET_GLOBAL) {
                    // 國際版
                    const roms = branch.roms || {};
                    const list = getSortedRoms(roms);
                    if (list.length > 0) {
                        globalData = list[0];
                    }
                }
            });

            // 只有當有台灣版資料時才回傳
            if (twData) {
                return {
                    code: code,
                    name: name,
                    brand: brand,
                    tw: twData,
                    global: globalData
                };
            }
            return null;
        }

        function getSortedRoms(romsObj) {
            const list = [];
            for (const k in romsObj) {
                const v = romsObj[k];
                list.push({
                    os: v.os || k,
                    android: v.android || '',
                    release: v.release || '1970-01-01'
                });
            }
            return list.sort((a, b) => new Date(b.release) - new Date(a.release));
        }

        function sortAndRender() {
            // 排序
            allDevices.sort((a, b) => new Date(b.tw.release) - new Date(a.tw.release));
            renderDevices(allDevices);
        }

        function updateBrandFilter() {
            const select = document.getElementById('brandFilter');
            const sortedBrands = Array.from(foundBrands).sort();
            
            let html = '<option value="all">所有品牌</option>';
            sortedBrands.forEach(b => {
                html += `<option value="${b}">${b}</option>`;
            });
            select.innerHTML = html;
        }

        function renderDevices(devices) {
            const container = document.getElementById('content');
            let html = '';
            
            devices.forEach(device => {
                const tw = device.tw;
                const gl = device.global;
                
                // 狀態判斷
                let verStatus = "text-gray-500";
                let verIcon = "";
                let glHtml = "";
                
                if (gl) {
                    if (tw.os < gl.os) {
                        verStatus = "text-red-500 bg-red-50";
                        verIcon = "↓ 落後";
                    } else if (tw.os > gl.os) {
                        verStatus = "text-green-600 bg-green-50";
                        verIcon = "↑ 領先";
                    } else {
                        verStatus = "text-gray-500 bg-gray-100";
                        verIcon = "= 同步";
                    }
                    
                    glHtml = `
                        <div class="flex items-center justify-between p-3 rounded-lg border border-dashed border-gray-300 bg-white/50">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">國際版</span>
                                <div>
                                    <div class="text-sm font-mono text-gray-600">${gl.os}</div>
                                    <div class="text-[10px] text-gray-400">Android ${gl.android}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 font-medium">${gl.release}</div>
                        </div>
                    `;
                } else {
                    glHtml = `
                        <div class="flex items-center justify-center p-3 rounded-lg border border-dashed border-gray-200 bg-gray-50">
                            <span class="text-xs text-gray-400 italic">無國際版資料</span>
                        </div>
                    `;
                }

                html += `
                    <div class="device-card bg-white rounded-2xl p-5 mb-4 shadow-sm hover:shadow-md transition-all duration-200 border border-gray-100" data-brand="${device.brand}">
                        <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-4">
                            <div class="flex items-start gap-3">
                                <div class="h-10 w-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 font-bold text-lg flex-shrink-0">
                                    ${device.name ? device.name[0] : '?'}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 leading-tight device-title">${device.name}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs font-mono text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 device-code">${device.code}</span>
                                        <span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">${device.brand}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-end">
                                <span class="text-xs text-gray-400 mb-1">台灣更新</span>
                                <span class="text-sm font-bold text-green-600 bg-green-50 px-2 py-1 rounded-md">${tw.release}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-center justify-between p-3 rounded-lg bg-blue-50/50 border border-blue-100">
                                <div class="flex items-center gap-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 shadow-sm">台灣版</span>
                                    <div>
                                        <div class="text-sm font-bold font-mono text-gray-800">${tw.os}</div>
                                        <div class="text-[10px] text-blue-400">Android ${tw.android}</div>
                                    </div>
                                </div>
                                ${gl ? `<span class="text-[10px] px-1.5 py-0.5 rounded ${verStatus}">${verIcon}</span>` : ''}
                            </div>
                            ${glHtml}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 過濾邏輯
        function filterContent() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedBrand = document.getElementById('brandFilter').value;
            
            const filtered = allDevices.filter(d => {
                const matchText = !searchText || d.name.toLowerCase().includes(searchText) || d.code.toLowerCase().includes(searchText);
                const matchBrand = selectedBrand === 'all' || d.brand === selectedBrand;
                return matchText && matchBrand;
            });
            
            renderDevices(filtered);
        }

        // 事件監聽
        document.getElementById('searchInput').addEventListener('input', filterContent);
        document.getElementById('brandFilter').addEventListener('change', filterContent);

        // 啟動
        init();
    </script>
</body>
</html>
